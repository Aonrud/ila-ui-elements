/*! ILA UI Elements
 *Copyright (C) 2021–2023 Aonghus Storey
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).ila={})}(this,(function(t){"use strict";function i(t,s){let e={};for(const h in t)s[h]&&typeof s[h]!=typeof t[h]?console.warn(`Config option ${h} has the wrong type of value. Skipping`):"object"!=typeof t[h]||t[h]instanceof Array||!s[h]?e[h]=s[h]??t[h]:e[h]=i(t[h],s[h]);return e}function s(t,i="",s="",e="",h="",o=null,n="button"){let c=document.createElement(n);if(c.id=`btn-${t}`,c.className=i,c.textContent=s,c.setAttribute("title",e),h){let t=document.createElement("span");t.className=h,c.append(t)}return"button"===n&&c.setAttribute("type","button"),o&&c.addEventListener("click",o),c}class e{constructor(t){this.t=t}attach(){this.t.addEventListener("touchstart",this),this.t.addEventListener("touchend",this)}detach(){this.t.removeEventListener("touchstart",this),this.t.removeEventListener("touchend",this)}handleEvent(t){"touchstart"==t.type&&(this.startX=t.changedTouches[0].clientX,this.startY=t.changedTouches[0].clientY),"touchend"==t.type&&(this.endX=t.changedTouches[0].clientX,this.endY=t.changedTouches[0].clientY,this.i())}i(){const t=this.endX-this.startX,i=this.endY-this.startY;let s=null;Math.abs(t)>Math.abs(i)&&(s=t>0?"right":"left"),Math.abs(t)<Math.abs(i)&&(s=i>0?"down":"up"),s&&(this.t.dispatchEvent(new CustomEvent("swiped",{detail:{direction:s}})),this.t.dispatchEvent(new CustomEvent(`swiped-${s}`)))}}const h={classes:{left:"scroller-left scroller-button",right:"scroller-right scroller-button"},texts:{left:"⮈",right:"⮊"},icons:{left:"",right:""},titles:{left:"Scroll back",right:"Scroll forward"},breakpoints:[[0,4],[768,4],[992,6],[1200,8]]};const o={targetClass:"viewer",panzoom:!1,showDownload:!1,showLink:!0,captions:["& + figcaption","& + .caption"],texts:{cue:"⨁",hide:"ⓧ",download:"⮋",prev:"⮈",next:"⮊",reveal:"ᴑ",revealActive:"ᴓ",link:"⛓",zoom:"🞕",zoomActive:"🞔"},icons:{cue:"",hide:"",download:"",prev:"",next:"",reveal:"",revealActive:"",link:"",zoom:"",zoomActive:""},titles:{cue:"",hide:"Close",download:"Download this image",prev:"Previous image",next:"Next image",reveal:"Reveal image",revealActive:"Blur image",link:"More information",zoom:"Enlarge image (drag to move the image around)",zoomActive:"Reset image to fit screen",zoomDisabled:"Zoom disabled (the image is already full size)"}};t.ImageViewer=class{constructor(t={}){this.h=i(o,t),this.o=document.querySelectorAll("img."+this.h.targetClass)}create(){this.l(),this.u()}next(){const t=this.m===this.o.length-1?0:this.m+1;this.show(t)}prev(){const t=0===this.m?this.o.length-1:this.m-1;this.show(t)}hide(){this.p&&(this.v.style.display="none",document.body.style.overflow="visible",this.v.blur(),this.p=!1)}show(t=0){this.p||(this.v.style.display="block",document.body.style.overflow="hidden",this.v.focus(),this.p=!0),Number.isInteger(t)&&this.g(t)}handleEvent(t){"click"==t.type&&this[t.currentTarget.id.replace("btn-","")](t)}async g(t){const i=this.o[t],s=this.k,e=i.dataset.full??i.src;this.m=t,this.h.panzoom&&s.classList.contains("pan")&&(this.btnToggle(document.getElementById("btn-zoom"),!1),this.zoomToggle(!1)),this.$.style.visibility="visible",this._(),s.dataset.loading=e;const h=await this.A(e);s.dataset.loading==h&&(console.log(h),await this.A(h,this.k),s.alt=i.getAttribute("alt"),this.$.style.visibility="hidden",this.I(t),this.revealToggle(!i.dataset.hasOwnProperty("reveal")||"true"==!i.dataset.reveal),this.C())}A(t,i=new Image){return console.log(`Loading ${t}`),new Promise((s=>{i.addEventListener("load",(()=>{s(t)})),i.src=t,i.dataset.loading=null}))}_(){this.k.src="",this.k.alt="",this.v.querySelector(".caption").style.display="none"}I(t){const i=this.v.querySelector(".caption");i.textContent="";const s=this.o[t].parentNode.parentNode;for(let e of this.h.captions){let h;e=e.replace("&",`#iv-${t}`),e.includes(":scope")?(e.replace(":scope",""),h=s.querySelector(e)):h=document.querySelector(e),h&&(i.textContent+=h.textContent)}this.o[t].dataset.caption&&(i.textContent=this.o.dataset.caption),this.o[t].dataset.captionId&&document.querySelector("#"+this.o[t].dataset.captionId)&&(i.textContent=document.querySelector("#"+this.o[t].dataset.captionId).textContent),""!==i.textContent?i.style.display="block":i.style.display="none"}zoom(t){const i=!this.k.classList.contains("pan");this.zoomToggle(i),this.btnToggle(t.currentTarget,i),t.currentTarget.classList.toggle("zoomed")}reveal(t){const i=this.k.style.filter.includes("blur");this.revealToggle(i),this.btnToggle(t.currentTarget,i)}btnToggle(t,i=!0){const s=t.id.replace("btn-",""),e=[...t.childNodes].filter((t=>t.nodeType===Node.TEXT_NODE))[0],h=i?this.h.texts[`${s}Active`]:this.h.texts[s],o=i?this.h.icons[`${s}Active`]:this.h.icons[s],n=i?this.h.titles[`${s}Active`]:this.h.titles[s];h&&(e||(e=document.createTextNode(),t.append(e)),e.textContent=h),o&&(t.querySelector("span").className=o),t.setAttribute("title",n)}zoomToggle(t=!0){const i=this.T;if(t)return this.M.detach(),this.k.classList.add("pan"),i.bind(),void i.setStyle("cursor","move");this.M.attach(),this.k.classList.remove("pan"),i.reset({animate:!1}),i.setStyle("cursor","auto"),i.destroy()}revealToggle(t=!0){const i=this.v.querySelector(".caption");t?(this.k.style.filter="",i.style.color=""):(this.k.style.filter="blur(1em)",i.style.color=getComputedStyle(i).getPropertyValue("background-color"))}u(){const t=document.createElement("div");t.classList.add("image-wrap");const i=document.createElement("div");i.classList.add("loader"),t.append(i);const s=document.createElement("img");t.append(s);const h=document.createElement("div");h.classList.add("caption");const o=document.createElement("div");o.id="overlay",o.style.display="none",o.setAttribute("tabindex",-1),o.append(t),o.append(h),o.append(this.S()),o.addEventListener("keydown",(t=>this.N(t))),this.M=new e(o),this.M.attach(),o.addEventListener("swiped-right",(()=>this.prev())),o.addEventListener("swiped-left",(()=>this.next())),o.addEventListener("swiped-up",(()=>this.hide())),this.v=o,this.k=s,this.B=h,this.$=i,this.p=!1,document.body.append(this.v),this.h.panzoom&&(this.T=this.T??Panzoom(this.k,{disableZoom:!0,noBind:!0}),this.zoomToggle(!1))}l(){for(const[t,i]of this.o.entries()){let s=i.parentElement;"A"!==s.tagName&&(s=document.createElement("a"),i.parentElement.insertBefore(s,i),s.append(i)),s.id=`iv-${t}`,s.classList.add("viewer-wrap");const e=document.createElement("div");e.classList.add("cue"),e.textContent=this.h.texts.cue,this.h.icons.cue&&this.L(this.h.icons.cue,e),s.append(e),s.addEventListener("click",(i=>{i.preventDefault(),this.show(t)}))}}S(){const t=document.createElement("nav");t.classList.add("image-viewer-controls"),t.setAttribute("aria-label","Image Viewer Controls");const i=["hide"];this.o.length>1&&i.push("next","prev"),i.push("reveal");const e=["download","link"];for(const e of i)t.append(s(e,"",this.h.texts[e],this.h.titles[e],this.h.icons[e],this));this.h.panzoom&&t.append(s("zoom","",this.h.texts.zoom,this.h.titles.zoom,this.h.icons.zoom,this));for(const i of e)this.h[`show${i.charAt(0).toUpperCase()+i.slice(1)}`]&&t.append(s(i,"",this.h.texts[i],this.h.titles[i],this.h.icons[i],void 0,"a"));return t}C(){const t=this.k,i=this.m;if(this.h.showDownload){const i=document.getElementById("btn-download");i.href=t.src,i.setAttribute("download","")}if(this.h.showLink){const t=document.getElementById("btn-link"),s=this.o[i].dataset.link?this.o[i].dataset.link:this.o[i].parentElement.href;s?(t.href=s,t.style.display="block"):(t.removeAttribute("href"),t.style.display="none")}const s=document.getElementById("btn-reveal");if("true"==this.o[i].dataset.reveal?s.style.display="block":s.style.display="none",this.h.panzoom){console.log(`Shown: ${t.width}; Actual: ${t.naturalWidth}`);const i=document.getElementById("btn-zoom");t.width<t.naturalWidth?(i.disabled=!1,i.setAttribute("title",this.h.titles.zoom)):(i.disabled=!0,i.setAttribute("title",this.h.titles.zoomDisabled))}}N(t){const i={Escape:"hide",ArrowLeft:"prev",ArrowRight:"next"};i.hasOwnProperty(t.key)&&"function"==typeof this[i[t.key]]&&(t.preventDefault(),this[i[t.key]]())}L(t,i){const s=document.createElement("span");s.classList.add(...t.split(" ")),i.append(s)}},t.Scroller=class{constructor(t,s={}){this.D=t,this.h=i(h,s),this.P(),this.R=void 0,this.j>this.H&&this.create()}create(){this.D.parentNode==this.Z&&"hidden"==this.Z.style.overflow||(this.F=s("left",this.h.classes.left,this.h.texts.left,this.h.titles.left,this.h.icons.left,this),this.O=s("right",this.h.classes.right,this.h.texts.right,this.h.titles.right,this.h.icons.right,this),this.V(),this.Z.style.overflow="hidden",this.F.disabled=!0,this.Z.append(this.F,this.O),this.D.style.left="0px",this.P(),window.addEventListener("resize",this),new e(this.Z),this.Z.addEventListener("swiped-right",(()=>this.left())),this.Z.addEventListener("swiped-left",(t=>this.right())))}handleEvent(t){"click"===t.type&&this[t.currentTarget.id.replace("btn-","")](t),"resize"===t.type&&void 0===this.R&&(this.R=setTimeout((()=>{this.P(),this.R=void 0}),500))}destroy(){this.D.style.left="0px",this.F.remove(),this.O.remove(),window.removeEventListener("resize",this.q),this.G()}left(){this.J(this.scroll(!1))}right(){this.J(this.scroll(!0))}J(t){this.F.disabled=0===t,this.O.disabled=t===-this.K}scroll(t=!0){const i=parseInt(this.D.style.left);let s=i+(t?-this.U:this.U);return s>0&&(s=0),s<-this.K&&(s=-this.K),!t&&this.O.disabled&&(s=i+this.K%this.U),this.D.style.left=s+"px",console.log(`Scrolling. Starting position: ${i}; New position: ${s}; Step size: ${this.U}; Display width: ${this.H}; Content width: ${this.j}; Max scroll: ${this.K}`),s}V(){const t=document.createElement("div");t.classList.add("scroller-wrapper"),this.D.parentNode.insertBefore(t,this.D),t.append(this.D),this.Z=t}G(){this.Z.parentNode.insertBefore(this.D,this.Z.previousSibling),this.Z.remove()}P(){const t=window.innerWidth,i=this.W(t,this.h.breakpoints);this.X(i);let s=window.getComputedStyle(this.D);const e=parseInt(s.getPropertyValue("padding-left"))+parseInt(s.getPropertyValue("padding-right"));this.j=this.D.scrollWidth-e,this.H=this.D.offsetWidth-e,this.Y=this.D.querySelector("li").offsetWidth,this.K=this.j-this.H,this.tt=Math.floor(this.H/this.Y),this.U=this.Y*this.tt}W(t,i){for(let s=0;s<i.length;s++)if(i[s][0]<=t&&(s==i.length-1||i[s+1][0]>t))return i[s][1]}X(t){if(isNaN(t))throw new Error(`Invalid number provided for row count: ${t}`);const i=this.D.querySelectorAll(".scroller li"),s=Math.round(1e6/(t+.25)/1e4);for(const t of i)t.style.flexBasis=s+"%"}},t.Toggler=class{constructor(t,i=null,s=null){this.it=t;try{this.st=i instanceof HTMLElement?i:document.getElementById(t.dataset.toggleTarget)}catch{throw new Error("Invalid target set. The target element must be provided either directly or with a data attribute")}this.st.classList.add("toggle-view");try{this.et=s||t.dataset.toggleText}catch{console.log("No toggle text")}this.ht=this.it.querySelector(".toggle-text")?this.it.querySelector(".toggle-text"):this.it,this.ot=this.ht.textContent,this.it.addEventListener("click",(()=>this.toggle()))}toggle(){this.st.classList.contains("visible")?this.hide():this.show()}show(){const t=this.st,i=this.nt(t);this.et&&(this.ht.textContent=this.et),t.classList.add("visible"),t.style.height=i,setTimeout((()=>t.style.height=""),250)}hide(){const t=this.st;this.et&&(this.ht.textContent=this.ot),t.style.height=t.scrollHeight+"px",setTimeout((()=>t.style.height=0),1),setTimeout((()=>t.classList.remove("visible")),250)}nt(t){t.style.display="block";const i=t.scrollHeight+"px";return t.style.display="",i}}}));
