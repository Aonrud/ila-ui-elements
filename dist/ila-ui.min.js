/*! ILA UI Elements
 *Copyright (C) 2021-2022 Aonghus Storey
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).ila={})}(this,(function(t){"use strict";function i(t,s){let o={};for(const e in t)s[e]&&typeof s[e]!=typeof t[e]?console.warn(`Config option ${e} has the wrong type of value. Skipping`):"object"!=typeof t[e]||t[e]instanceof Array||!s[e]?o[e]=s[e]??t[e]:o[e]=i(t[e],s[e]);return o}function s(t,i="",s="",o="",e="",h=null,n="button"){let c=document.createElement(n);if(c.id=`btn-${t}`,c.className=i,c.textContent=s,c.setAttribute("title",o),e){let t=document.createElement("span");t.className=e,c.append(t)}return"button"===n&&c.setAttribute("type","button"),h&&c.addEventListener("click",h),c}const o={classes:{left:"scroller-left scroller-button",right:"scroller-right scroller-button"},texts:{left:"⮈",right:"⮊"},icons:{left:"",right:""},titles:{left:"Scroll back",right:"Scroll forward"},breakpoints:[[0,4],[768,4],[992,6],[1200,8]]};const e={targetClass:"viewer",panzoom:!1,showDownload:!1,showLink:!0,texts:{cue:"⨁",hide:"ⓧ",download:"⮋",prev:"⮈",next:"⮊",link:"⛓",zoom:"🞕",zoomActive:"🞔"},icons:{cue:"",hide:"",download:"",prev:"",next:"",link:"",zoom:"",zoomActive:""},titles:{cue:"",hide:"Close",download:"Download this image",prev:"Previous image",next:"Next image",link:"More information",zoom:"Enlarge image (drag to move the image around)",zoomActive:"Reset image to fit screen",zoomDisabled:"Zoom disabled (the image is already full size)"}};t.ImageViewer=class{constructor(t={}){this.t=i(e,t),this.i=document.querySelectorAll("img."+this.t.targetClass)}create(){this.o(),this.h()}next(){const t=this.l===this.i.length-1?0:this.l+1;this.show(t)}prev(){const t=0===this.l?this.i.length-1:this.l-1;this.show(t)}hide(){this.u&&(this.m.style.display="none",document.body.style.overflow="visible",this.m.blur(),this.u=!1)}show(t=0){this.u||(this.m.style.display="block",document.body.style.overflow="hidden",this.m.focus(),this.u=!0),Number.isInteger(t)&&this.p(t)}handleEvent(t){"click"==t.type&&this[t.currentTarget.id.replace("btn-","")](t)}async p(t){const i=this.i[t],s=this.g,o=i.dataset.full??i.src;this.l=t,this.t.panzoom&&s.classList.contains("pan")&&(this.btnToggle(document.getElementById("btn-zoom"),!1),this.zoomToggle(!1)),this.v.style.visibility="visible",this.k(),s.dataset.loading=o;const e=await this._(o);s.dataset.loading==e&&(console.log(e),await this._(e,this.g),s.alt=i.getAttribute("alt"),this.v.style.visibility="hidden",this.$(t),this.I())}_(t,i=new Image){return console.log(`Loading ${t}`),new Promise((s=>{i.addEventListener("load",(()=>{s(t)})),i.src=t,i.dataset.loading=null}))}k(){this.g.src="",this.g.alt="",this.m.querySelector(".caption").style.display="none"}$(t){const i=this.m.querySelector(".caption"),s=this.i[t].parentElement.nextElementSibling;s&&("FIGCAPTION"===s.tagName||s.classList.contains("caption"))?(i.textContent=s.textContent,i.style.display="block"):i.style.display="none"}zoom(t){const i=!this.g.classList.contains("pan");this.zoomToggle(i),this.btnToggle(t.currentTarget,i),t.currentTarget.classList.toggle("zoomed")}btnToggle(t,i=!0){const s=t.id.replace("btn-",""),o=[...t.childNodes].filter((t=>t.nodeType===Node.TEXT_NODE))[0],e=i?this.t.texts[`${s}Active`]:this.t.texts[s],h=i?this.t.icons[`${s}Active`]:this.t.icons[s],n=i?this.t.titles[`${s}Active`]:this.t.titles[s];e&&(o||(o=document.createTextNode(),t.append(o)),o.textContent=e),h&&(t.querySelector("span").className=h),t.setAttribute("title",n)}zoomToggle(t=!0){const i=this.A;if(t)return this.g.classList.add("pan"),i.bind(),void i.setStyle("cursor","move");this.g.classList.remove("pan"),i.reset({animate:!1}),i.setStyle("cursor","auto"),i.destroy()}h(){const t=document.createElement("div");t.classList.add("image-wrap");const i=document.createElement("div");i.classList.add("loader"),t.append(i);const s=document.createElement("img");t.append(s);const o=document.createElement("div");o.classList.add("caption");const e=document.createElement("div");e.id="overlay",e.style.display="none",e.setAttribute("tabindex",-1),e.append(t),e.append(o),e.append(this.C()),e.addEventListener("keydown",(t=>this.S(t))),this.m=e,this.g=s,this.v=i,this.u=!1,document.body.append(this.m),this.t.panzoom&&(this.A=this.A??Panzoom(this.g,{disableZoom:!0,noBind:!0}),this.zoomToggle(!1))}o(){for(const[t,i]of this.i.entries()){let s=i.parentElement;"A"!==s.tagName&&(s=document.createElement("a"),i.parentElement.insertBefore(s,i),s.append(i)),s.classList.add("viewer-wrap");const o=document.createElement("div");o.classList.add("cue"),o.textContent=this.t.texts.cue,this.t.icons.cue&&this.N(this.t.icons.cue,o),s.append(o),s.addEventListener("click",(i=>{i.preventDefault(),this.show(t)}))}}C(){const t=document.createElement("nav");t.classList.add("image-viewer-controls"),t.setAttribute("aria-label","Image Viewer Controls");const i=["hide"];this.i.length>1&&i.push("next","prev");const o=["download","link"];for(const o of i)t.append(s(o,"",this.t.texts[o],this.t.titles[o],this.t.icons[o],this));this.t.panzoom&&t.append(s("zoom","",this.t.texts.zoom,this.t.titles.zoom,this.t.icons.zoom,this));for(const i of o)this.t[`show${i.charAt(0).toUpperCase()+i.slice(1)}`]&&t.append(s(i,"",this.t.texts[i],this.t.titles[i],this.t.icons[i],void 0,"a"));return t}I(){const t=this.g,i=this.l;if(this.t.showDownload){const i=document.getElementById("btn-download");i.href=t.src,i.setAttribute("download","")}if(this.t.showLink){const t=document.getElementById("btn-link"),s=this.i[i].dataset.link?this.i[i].dataset.link:this.i[i].parentElement.href;s?(t.href=s,t.style.display="block"):(t.removeAttribute("href"),t.style.display="none")}if(this.t.panzoom){console.log(`Shown: ${t.width}; Actual: ${t.naturalWidth}`);const i=document.getElementById("btn-zoom");t.width<t.naturalWidth?(i.disabled=!1,i.setAttribute("title",this.t.titles.zoom)):(i.disabled=!0,i.setAttribute("title",this.t.titles.zoomDisabled))}}S(t){const i={Escape:"hide",ArrowLeft:"prev",ArrowRight:"next"};i.hasOwnProperty(t.key)&&"function"==typeof this[i[t.key]]&&(t.preventDefault(),this[i[t.key]]())}N(t,i){const s=document.createElement("span");s.classList.add(...t.split(" ")),i.append(s)}},t.Scroller=class{constructor(t,s={}){this.T=t,this.t=i(o,s),this.M(),this.B=void 0,this.D>this.L&&this.create()}create(){this.T.parentNode==this.P&&"hidden"==this.P.style.overflow||(this.j=s("left",this.t.classes.left,this.t.texts.left,this.t.titles.left,this.t.icons.left,this),this.O=s("right",this.t.classes.right,this.t.texts.right,this.t.titles.right,this.t.icons.right,this),this.F(),this.P.style.overflow="hidden",this.j.disabled=!0,this.P.append(this.j,this.O),this.T.style.left="0px",this.M(),window.addEventListener("resize",this))}handleEvent(t){"click"===t.type&&this[t.currentTarget.id.replace("btn-","")](t),"resize"===t.type&&void 0===this.B&&(this.B=setTimeout((()=>{this.M(),this.B=void 0}),500))}destroy(){this.T.style.left="0px",this.j.remove(),this.O.remove(),window.removeEventListener("resize",this.R),this.Z()}left(){this.G(this.scroll(!1))}right(){this.G(this.scroll(!0))}G(t){this.j.disabled=0===t,this.O.disabled=t===-this.V}scroll(t=!0){const i=parseInt(this.T.style.left);let s=i+(t?-this.q:this.q);return s>0&&(s=0),s<-this.V&&(s=-this.V),!t&&this.O.disabled&&(s=i+this.V%this.q),this.T.style.left=s+"px",console.log(`Scrolling. Starting position: ${i}; New position: ${s}; Step size: ${this.q}; Display width: ${this.L}; Content width: ${this.D}; Max scroll: ${this.V}`),s}F(){const t=document.createElement("div");t.classList.add("scroller-wrapper"),this.T.parentNode.insertBefore(t,this.T),t.append(this.T),this.P=t}Z(){this.P.parentNode.insertBefore(this.T,this.P.previousSibling),this.P.remove()}M(){const t=window.innerWidth,i=this.H(t,this.t.breakpoints);this.J(i);let s=window.getComputedStyle(this.T);const o=parseInt(s.getPropertyValue("padding-left"))+parseInt(s.getPropertyValue("padding-right"));this.D=this.T.scrollWidth-o,this.L=this.T.offsetWidth-o,this.K=this.T.querySelector("li").offsetWidth,this.V=this.D-this.L,this.U=Math.floor(this.L/this.K),this.q=this.K*this.U}H(t,i){for(let s=0;s<i.length;s++)if(i[s][0]<=t&&(s==i.length-1||i[s+1][0]>t))return i[s][1]}J(t){if(isNaN(t))throw new Error(`Invalid number provided for row count: ${t}`);const i=this.T.querySelectorAll(".scroller li"),s=Math.round(1e6/(t+.25)/1e4);for(const t of i)t.style.flexBasis=s+"%"}},Object.defineProperty(t,"W",{value:!0})}));
